<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sql.message">
	
	<resultMap id="msgDetailMap" type="map" >
		<id column="sMsgNo" jdbcType="BIGINT" property="sMsgNo"/>
    	<result column="content" jdbcType="CLOB" javaType="java.lang.String" property="content"/>
    	<result column="title" jdbcType="VARCHAR" property="title"/>
    	<result column="recipient" jdbcType="VARCHAR" property="recipient"/>
		<result column="regdate" jdbcType="TIMESTAMP" property="regdate"/>
	</resultMap>

	<sql id="messageViewCol">
		sMsgNo, sender, title, content, sDelFlag, regdate, code, rMsgNo, recipient, rDelFlag, readFlag
	</sql>
	
	<sql id="searchWhere">
		<if test="searchVo.searchKeyword !=null and searchVo.searchKeyword !=''">
			${searchVo.searchCondition} like '%' || #{searchVo.searchKeyword} || '%' and
		</if>
	</sql>


	<insert id="insertSendMsg" parameterType="sendMsgVo">
		<selectKey keyProperty="sMsgNo" order="BEFORE" resultType="int">
			select sendMsg_seq.nextval from dual
		</selectKey>
		insert into sendmsg(smsgNo, sender, title, content, code)
		values(#{sMsgNo}, #{sender}, #{title}, #{content}, #{code})
	</insert>
	
	<insert id="insertReceiveMsg" parameterType="receiveMsgVo">
		insert into receivemsg(rMsgNo, sMsgNo, recipient)
		values(receivemsg_seq.nextval, #{sMsgNo}, #{recipient})
	</insert>
	
	<select id="selectSendMsg" parameterType="map" resultType="map">
		select *
		from
		(
		    select rownum as RNUM, list.*
		    from (
		        select 
		        <include refid="messageViewCol"></include>		
				 from message
				 where
				<include refid="searchWhere"></include>					
				 sender=#{sender} and code=#{code}
				order by smsgno desc
		    )list
		)    
		<![CDATA[
		where RNUM>#{searchVo.firstRecordIndex} 
		and RNUM<=#{searchVo.firstRecordIndex}+#{searchVo.recordCountPerPage}
		]]>
	</select>
	
	<select id="getTotalRecord" parameterType="map" resultType="int">
		select count(*) from message
		where 
		<include refid="searchWhere"></include>
		sender=#{sender} and code=#{code}		
	</select>
	
	
	
	<select id="selectReceiveMsg" parameterType="map" resultType="map">
		select *
		from
		(
		    select rownum as RNUM, list.*
		    from (
		        select 
		        <include refid="messageViewCol"></include>		
				 from message
				 where
				<include refid="searchWhere"></include>					
				 recipient=#{recipient} and code!=#{code}
				order by smsgno desc
		    )list
		)    
		<![CDATA[
		where RNUM>#{searchVo.firstRecordIndex} 
		and RNUM<=#{searchVo.firstRecordIndex}+#{searchVo.recordCountPerPage}
		]]>
	</select>
	
	<select id="getTotalRecordReceive" parameterType="map" resultType="int">
		select count(*) from message
		where 
		<include refid="searchWhere"></include>
		recipient=#{recipient} and code!=#{code}		
	</select>
	
	<select id="selectDetail" parameterType="int" resultMap="msgDetailMap">
		select sMsgNo, title, content, regdate, recipient from message where sMsgno=#{sMsgNo}	
	</select>
</mapper>









