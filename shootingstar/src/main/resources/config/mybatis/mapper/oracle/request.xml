<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="config.mybatis.mapper.oracle.request">
	
	<resultMap id="pickAll" type="PickAllVO">
		<result property="pickNo" column="pickno" />
		<result property="RQNo" column="rqno" />
		<result property="sMemberId" column="smemberid" />
		<result property="sPrice" column="sprice" />
		<result property="choice" column="chioce" />
		<result property="pLevel" column="plevel" />
		<result property="sName" column="sname" />
	</resultMap>
	
	<sql id="requestCol">
		rqno, memberid, cgno, rqprice, rqregion, rqdate,
		rqtype, pickcount, rqdetail, regdate, delflag
	</sql>
	
	<sql id="searchWhere">
		<if test="searchKeyword !=null and searchKeyword !=''">
			<where>
				${searchCondition} like '%' || #{searchKeyword} || '%'
			</where>
		</if>
	</sql>
	
	<insert id="insertRequest" parameterType="RequestVO">
		<selectKey keyProperty="RQNo" order="BEFORE" resultType="int">
			select request_seq.nextval from dual
		</selectKey>
		insert into request(rqno, memberid, cgno, rqprice, rqregion, rqdate, rqtype, rqdetail) 
		values(#{RQNo}, #{memberId}, #{cgNo}, #{RQPrice}, #{RQRegion} ,#{RQDate}, #{RQType}, #{RQDetail})
	</insert>

	<insert id="insertReqImg" parameterType="RequestImgVO">
		insert into requestimg(rqimgno, rqno, originalfilename, filename) 
		values(requestimg_seq.nextval, #{RQNo}, #{originalFileName}, #{fileName})
	</insert>


	<select id="selectAll" parameterType="ctgRequestVO" resultType="RequestVO">
		select *
		from
		(
		    select rownum as RNUM, list.*
		    from (
		    	<choose>
			        <when test="cgNo==null or cgNo=='' or cgNo==0">
		        select 
				<include refid="requestCol"></include>		
				 from request
				<include refid="searchWhere"></include>
				
				</when>
					<otherwise>		
						select 
						<include refid="requestCol"></include>		
						 from request
						where cgNo=#{cgNo}
					</otherwise>			
				</choose>
				order by rqno desc	
				
		    )list
		)    
		<![CDATA[
		where RNUM>#{firstRecordIndex} 
		and RNUM<=#{firstRecordIndex}+#{recordCountPerPage}
		]]>
	</select>
	
	
	
	<select id="getTotalRecord" parameterType="ctgRequestVO" resultType="int">
		<choose>
	         <when test="cgNo==null or cgNo==''">
		        select count(*)	
				 from request
				<include refid="searchWhere"></include>			
			</when>
			<otherwise>				
				select count(*)		
				 from request
				where cgNo=#{cgNo}
			</otherwise>			
		</choose>
			
	</select>
	
	
	<select id="selectByNo" parameterType="int" resultType="RequestVO">
		select * from request where RQNo=#{RQNo}
	</select>
	
	<select id="pickByNo" parameterType="int" resultType="RequestPickVO">
		select * from pick where RQNo=#{RQNo}
	</select>
	
	
	<select id="selectPList" parameterType="int" resultMap="pickAll">
		select * from pickAll
		where rqno=#{no}
	</select>
	

	<select id="selectByNoImg" parameterType="int" resultType="RequestImgVO">
		select * from requestimg where RQNo=#{RQNo}
	</select>
	

	<insert id="insertPick" parameterType="RequestPickVO">
		insert into pick (pickno, rqno, smemberid, sprice)
		values(pick_seq.nextval, #{RQNo}, #{sMemberId}, #{sPrice})
	</insert>
	
	
	<update id="updatePick" parameterType="int">
		update request
		set pickcount=pickcount+1
		where rqno=#{no}
	</update>
	
	
	<select id="getPickCount" parameterType="int" resultType="int">
		select pickcount from request
		where rqno=#{no}
	</select>
	
	
	
	<update id="updatePlevel" parameterType="int">
		update pickall
		set plevel = plevel+1
		where pickno=#{no}
	</update>
	
	
	<select id="getPickNo" parameterType="int" resultType="int">
		select pickno from pickall
		where plevel>=1 and rqno=#{no}
	</select>

	<select id="getPkMem" parameterType="int" resultType="String">
		select smemberid from pickall
		where pickno=#{no}
	</select>
	
	<update id="updatePrice" parameterType="hashmap">
		update pickall
		set sprice=#{price}
		where pickno=#{no}
	</update>
	
	<select id="getFinalP" parameterType="int" resultType="int">
		select sprice from pickall where rqno=#{no} and plevel>=1
	</select>

	<select id="getPLevel" parameterType="int" resultType="int">
		select count (*) from pickall
		where rqno=#{no} and plevel>=1
	</select>
	
	<select id="getPLevel2" parameterType="int" resultType="int">
		select count (*) from pickall
		where rqno=#{no} and plevel>=2
	</select>
	
	
	<select id="selectPayAll" parameterType="int" resultType="PayfinishVO">
		select * from payfinish
		where rqno=#{no}
	</select>
	
	
	<insert id="insertPayment" parameterType="PayfinishVO">
		insert into rqpayment(pno, memberid, pmethod, pprice, mileage, pickno)
		values(rqpayment_seq.nextval, #{memberId}, #{pMethod}, #{sPrice}, #{mileage}, #{pickNo})
	</insert>
	
	
	<select id="selectByPay" parameterType="int" resultType="PaymentVO">
		select * from rqpayment
		where pno=#{pNo}
	</select>

	<update id="updateMileage" parameterType="MemberVO">
      update member
      set mileage=#{mileage}
      where memberid=#{memberId}
   	</update> 
	
	
</mapper>


